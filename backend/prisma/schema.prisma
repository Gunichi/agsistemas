generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  role         UserRole  @default(PENDING)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLogin    DateTime? @map("last_login")
  
  member                Member?
  reviewedIntents       MembershipIntent[]     @relation("IntentReviewer")
  referralStatusChanges ReferralStatusHistory[]
  auditLogs             AuditLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MEMBER
  PENDING
}

model MembershipIntent {
  id              String        @id @default(uuid())
  fullName        String        @map("full_name")
  email           String
  phone           String?
  company         String?
  industry        String?
  motivation      String?       @db.Text
  status          IntentStatus  @default(PENDING)
  reviewedById    String?       @map("reviewed_by")
  reviewedAt      DateTime?     @map("reviewed_at")
  rejectionReason String?       @map("rejection_reason") @db.Text
  inviteToken     String?       @unique @map("invite_token")
  tokenExpiresAt  DateTime?     @map("token_expires_at")
  createdAt       DateTime      @default(now()) @map("created_at")

  reviewedBy User?   @relation("IntentReviewer", fields: [reviewedById], references: [id])
  member     Member?

  @@index([status])
  @@index([email])
  @@map("membership_intents")
}

enum IntentStatus {
  PENDING
  APPROVED
  REJECTED
}

model Member {
  id                  String         @id @default(uuid())
  userId              String         @unique @map("user_id")
  intentId            String?        @unique @map("intent_id")
  
  fullName            String         @map("full_name")
  email               String         @unique
  phone               String?
  cpf                 String?        @unique
  birthDate           DateTime?      @map("birth_date") @db.Date
  photoUrl            String?        @map("photo_url")
  
  company             String?
  position            String?
  industry            String?
  businessDescription String?        @map("business_description") @db.Text
  website             String?
  linkedinUrl         String?        @map("linkedin_url")
  
  addressStreet       String?        @map("address_street")
  addressNumber       String?        @map("address_number")
  addressComplement   String?        @map("address_complement")
  addressNeighborhood String?        @map("address_neighborhood")
  addressCity         String?        @map("address_city")
  addressState        String?        @map("address_state")
  addressZipcode      String?        @map("address_zipcode")
  
  status              MemberStatus   @default(ACTIVE)
  membershipStartDate DateTime       @default(now()) @map("membership_start_date") @db.Date
  membershipEndDate   DateTime?      @map("membership_end_date") @db.Date
  
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  user                     User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  intent                   MembershipIntent?      @relation(fields: [intentId], references: [id])
  referralsGiven           BusinessReferral[]     @relation("ReferralGiver")
  referralsReceived        BusinessReferral[]     @relation("ReferralReceiver")
  meetingAttendances       MeetingAttendance[]
  monthlyFees              MonthlyFee[]
  oneOnOneMeetingsAsMember1 OneOnOneMeeting[]     @relation("Member1")
  oneOnOneMeetingsAsMember2 OneOnOneMeeting[]     @relation("Member2")
  oneOnOneMeetingsRegistered OneOnOneMeeting[]    @relation("MeetingRegistrar")
  thankYousSent            ThankYou[]             @relation("ThankYouSender")
  thankYousReceived        ThankYou[]             @relation("ThankYouReceiver")
  announcementReads        AnnouncementRead[]

  @@index([status])
  @@index([email])
  @@index([userId])
  @@map("members")
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model Announcement {
  id             String              @id @default(uuid())
  title          String
  content        String              @db.Text
  authorId       String              @map("author_id")
  priority       AnnouncementPriority @default(NORMAL)
  isPublished    Boolean             @default(false) @map("is_published")
  publishedAt    DateTime?           @map("published_at")
  expiresAt      DateTime?           @map("expires_at")
  targetAudience String              @default("all") @map("target_audience")
  
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")

  reads          AnnouncementRead[]

  @@index([isPublished, publishedAt])
  @@map("announcements")
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model AnnouncementRead {
  id             String   @id @default(uuid())
  announcementId String   @map("announcement_id")
  memberId       String   @map("member_id")
  readAt         DateTime @default(now()) @map("read_at")

  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  member         Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([announcementId, memberId])
  @@map("announcement_reads")
}

model Meeting {
  id          String        @id @default(uuid())
  title       String
  description String?       @db.Text
  meetingDate DateTime      @map("meeting_date") @db.Date
  meetingTime DateTime      @map("meeting_time") @db.Time
  location    String?
  meetingType MeetingType   @default(REGULAR) @map("meeting_type")
  status      MeetingStatus @default(SCHEDULED)
  
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  attendances MeetingAttendance[]

  @@index([meetingDate, status])
  @@map("meetings")
}

enum MeetingType {
  REGULAR
  SPECIAL
  ONLINE
}

enum MeetingStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

model MeetingAttendance {
  id          String            @id @default(uuid())
  meetingId   String            @map("meeting_id")
  memberId    String            @map("member_id")
  checkInTime DateTime          @default(now()) @map("check_in_time")
  status      AttendanceStatus  @default(PRESENT)
  notes       String?           @db.Text
  
  meeting     Meeting           @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  member      Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([meetingId, memberId])
  @@index([meetingId])
  @@index([memberId])
  @@map("meeting_attendances")
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

model BusinessReferral {
  id             String           @id @default(uuid())
  referrerId     String           @map("referrer_id")
  referredToId   String           @map("referred_to_id")
  
  clientName     String           @map("client_name")
  clientPhone    String?          @map("client_phone")
  clientEmail    String?          @map("client_email")
  description    String           @db.Text
  estimatedValue Decimal?         @map("estimated_value") @db.Decimal(15, 2)
  
  status         ReferralStatus   @default(PENDING)
  feedback       String?          @db.Text
  closedValue    Decimal?         @map("closed_value") @db.Decimal(15, 2)
  closedAt       DateTime?        @map("closed_at")
  
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  referrer       Member           @relation("ReferralGiver", fields: [referrerId], references: [id])
  referredTo     Member           @relation("ReferralReceiver", fields: [referredToId], references: [id])
  statusHistory  ReferralStatusHistory[]
  thankYou       ThankYou?

  @@index([referrerId])
  @@index([referredToId])
  @@index([status])
  @@map("business_referrals")
}

enum ReferralStatus {
  PENDING
  CONTACTED
  NEGOTIATING
  CLOSED
  LOST
  CANCELLED
}

model ReferralStatusHistory {
  id          String    @id @default(uuid())
  referralId  String    @map("referral_id")
  fromStatus  String?   @map("from_status")
  toStatus    String    @map("to_status")
  changedBy   String?   @map("changed_by")
  notes       String?   @db.Text
  changedAt   DateTime  @default(now()) @map("changed_at")

  referral    BusinessReferral @relation(fields: [referralId], references: [id], onDelete: Cascade)
  user        User?            @relation(fields: [changedBy], references: [id])

  @@map("referral_status_history")
}

model ThankYou {
  id            String   @id @default(uuid())
  referralId    String   @unique @map("referral_id")
  fromMemberId  String   @map("from_member_id")
  toMemberId    String   @map("to_member_id")
  message       String   @db.Text
  isPublic      Boolean  @default(true) @map("is_public")
  businessValue Decimal? @map("business_value") @db.Decimal(15, 2)
  
  createdAt     DateTime @default(now()) @map("created_at")

  referral      BusinessReferral @relation(fields: [referralId], references: [id])
  fromMember    Member           @relation("ThankYouSender", fields: [fromMemberId], references: [id])
  toMember      Member           @relation("ThankYouReceiver", fields: [toMemberId], references: [id])

  @@index([isPublic, createdAt])
  @@map("thank_yous")
}

model OneOnOneMeeting {
  id           String              @id @default(uuid())
  member1Id    String              @map("member1_id")
  member2Id    String              @map("member2_id")
  meetingDate  DateTime            @map("meeting_date") @db.Date
  location     String?
  notes        String?             @db.Text
  status       OneOnOneStatus      @default(SCHEDULED)
  registeredBy String              @map("registered_by")
  
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  member1      Member              @relation("Member1", fields: [member1Id], references: [id])
  member2      Member              @relation("Member2", fields: [member2Id], references: [id])
  registrar    Member              @relation("MeetingRegistrar", fields: [registeredBy], references: [id])

  @@index([member1Id, member2Id])
  @@index([meetingDate])
  @@map("one_on_one_meetings")
}

enum OneOnOneStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

model MonthlyFee {
  id                  String          @id @default(uuid())
  memberId            String          @map("member_id")
  
  referenceMonth      Int             @map("reference_month")
  referenceYear       Int             @map("reference_year")
  amount              Decimal         @db.Decimal(10, 2)
  dueDate             DateTime        @map("due_date") @db.Date
  
  status              PaymentStatus   @default(PENDING)
  paymentDate         DateTime?       @map("payment_date")
  paymentMethod       String?         @map("payment_method")
  paymentTransactionId String?        @unique @map("payment_transaction_id")
  paymentProofUrl     String?         @map("payment_proof_url")
  
  notes               String?         @db.Text
  
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  member              Member          @relation(fields: [memberId], references: [id], onDelete: Cascade)
  reminders           PaymentReminder[]

  @@unique([memberId, referenceMonth, referenceYear])
  @@index([memberId])
  @@index([status])
  @@index([dueDate])
  @@index([referenceYear, referenceMonth])
  @@map("monthly_fees")
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

model PaymentReminder {
  id           String         @id @default(uuid())
  monthlyFeeId String         @map("monthly_fee_id")
  reminderType ReminderType   @map("reminder_type")
  sentAt       DateTime       @default(now()) @map("sent_at")
  status       ReminderStatus

  monthlyFee   MonthlyFee     @relation(fields: [monthlyFeeId], references: [id], onDelete: Cascade)

  @@map("payment_reminders")
}

enum ReminderType {
  EMAIL
  SMS
  WHATSAPP
}

enum ReminderStatus {
  SENT
  DELIVERED
  FAILED
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent") @db.Text
  
  createdAt  DateTime @default(now()) @map("created_at")

  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}


